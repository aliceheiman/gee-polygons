"""Sentinel-2 presets for vegetation indices (NDVI, EVI) and spectral bands."""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../../nbs/12_datasets_sentinel2.ipynb.

# %% auto #0
__all__ = ['SENTINEL2_NDVI_EVI', 'add_indices', 'mask_s2_clouds', 'get_s2_collection']

# %% ../../nbs/12_datasets_sentinel2.ipynb #90d843f3
import ee
from ..layers import ContinuousLayer

# %% ../../nbs/12_datasets_sentinel2.ipynb #9405b3dd
def add_indices(image):
    """Add NDVI and EVI bands to a Sentinel-2 image.

    Note: Expects raw Sentinel-2 SR reflectance (scaled by 10000).
    Scales to 0-1 range before computing indices.
    """
    # Scale reflectance from 0-10000 to 0-1 range
    scaled = image.divide(10000)

    ndvi = scaled.normalizedDifference(['B8', 'B4']).rename('NDVI')

    evi = scaled.expression(
        '2.5 * ((NIR - RED) / (NIR + 6 * RED - 7.5 * BLUE + 1))',
        {
            'NIR': scaled.select('B8'),
            'RED': scaled.select('B4'),
            'BLUE': scaled.select('B2')
        }
    ).rename('EVI')

    return image.addBands([ndvi, evi])


def mask_s2_clouds(image):
    """Mask clouds in Sentinel-2 imagery using QA60 band."""
    qa = image.select('QA60')
    
    # Bits 10 and 11 are clouds and cirrus
    cloud_bit_mask = 1 << 10
    cirrus_bit_mask = 1 << 11
    
    mask = (qa.bitwiseAnd(cloud_bit_mask).eq(0)
            .And(qa.bitwiseAnd(cirrus_bit_mask).eq(0)))
    
    return image.updateMask(mask)

# %% ../../nbs/12_datasets_sentinel2.ipynb #c331b0f0
def get_s2_collection(start_date: str, end_date: str, geometry=None, cloud_pct: int = 20):
    """Get a processed Sentinel-2 collection with NDVI and EVI.
    
    Args:
        start_date: Start date (YYYY-MM-DD)
        end_date: End date (YYYY-MM-DD)
        geometry: Optional geometry to filter bounds
        cloud_pct: Maximum cloud cover percentage (default 20)
        
    Returns:
        ee.ImageCollection with NDVI and EVI bands added
    """
    collection = (
        ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
        .filterDate(start_date, end_date)
        .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', cloud_pct))
        .map(mask_s2_clouds)
        .map(add_indices)  # Scaling happens inside add_indices
    )
    
    if geometry is not None:
        collection = collection.filterBounds(geometry)
    
    return collection

# %% ../../nbs/12_datasets_sentinel2.ipynb #013e159f
# These presets work with the raw Sentinel-2 collection
# The extract_continuous function should handle index computation

SENTINEL2_NDVI_EVI = ContinuousLayer(
    collection_id='COPERNICUS/S2_SR_HARMONIZED',
    bands=['NDVI', 'EVI'],
    scale=10,
    preprocess=add_indices
)
